<!DOCTYPE html>
<html>
<head>

<meta name='keywords' content='WebRTC, HTML5, JavaScript' />
<meta name='description' content='WebRTC Reference App' />
<meta name='viewport' content='width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1'>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

<base target='_blank'>

<title>WebRTC client</title>

<!-- <link rel='stylesheet' href='css/main.css' /> -->

</head>

<body>

<div id='container'>

<div id="my-peer-id"></div>

<br>
<br>

<form id="connect-form">
  Enter a Peer ID to connect to: <input type="text" name="peer-id" id="id-entry"><br>
  <input id="connect-btn" type="submit" value="Connect!">
</form>

<br>
<br>

<form id="message-form">
  Enter a messge for all peers: <input type="text" id="message-entry"><br>
  <input id="send-btn" type="submit" value="Send!">
</form>

<br>
<br>

<div id="log"></div>

</div>

<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>

<script type="text/javascript">
   // Constants
   var MESSAGE = 0;
   var ADD_CONNECTION = 1;
   var USER_DISCONNECTED = 2;

   // Stores the incoming connections
   var connected_friends = [];

	var global_conn;
	var peer = new Peer({key: 'is1zfbruud31sjor'});
	var my_id = "not set";

	// Open the connection to the PeerJS servers, and update the label
	peer.on('open', function(id) {
  		$("#my-peer-id").html("My ID is: <br /> <b>" + id + "</b>");
  		my_id = id;
	});

	function receive_message(data) {
		if (data.message) {
			$("#log").append(
			                 $('<div/>')
			                 .addClass("message")
			                 .html("<b>" + data.username + ": </b>" + data.message)
			                 );
		}
	}

	// Called when I connect to someone, or when someone connects to me!
	function new_connection_established(connection) {
		connected_friends.push(connection);
		$("#log").append(
		                 $('<div/>')
		                 .addClass("new-connection-message")
	                 	  .html("<b>Successfully connected to " + connection.peer + "</b>")
		                 );

		// This sets up a function to be called whenever we receive data
		//  from this connection.
		connection.on('data', function(data) {
			receive_message(data);
		});

		// Peer died! Let the user know.
		connection.on('close', function() {
			$("#log").append(
			                 $('<div/>')
			                 .addClass("connection-closed-message")
		                    .html("<b>" + connection.peer + " disconnected </b>")
			                 );
		});
	}


	// Stop the default form action (which is to open another page)
	$('#connect-form').submit(false);

	// This is called when the user hits "Connect"
	$("#connect-btn").click(function() {
		// Tries to connect to a new friend with the peer ID "other_id"
		var new_connection = peer.connect($("#id-entry").val());

		new_connection.on('open', function() {
			new_connection_established(new_connection);
		});

		return false;
	});

	// Stop the default form action (which is to open another page)
	$('#message-form').submit(false);

	// This is called when the user hits "Send"
	$("#send-btn").click(function() {
		// Send a data message to all peers
		for (var ndx = 0; ndx < connected_friends.length; ndx++) {
			connected_friends[ndx].send({
					username: my_id, 
					message: $("#message-entry").val()});
		}

		// Also print my own messages
		receive_message({
					username: "me", 
					message: $("#message-entry").val()});

		return false;
	});


	// Listen for new peers connecting TO me
	peer.on('connection', function(incoming_connection) { 
		new_connection_established(incoming_connection);
	});

	// Alert friends when we're disconnecting
	window.onbeforeunload = function() {
   	for (var ndx = 0; ndx < connected_friends.length; ndx++) {
			connected_friends[ndx].send({
				   type: MESSAGE,
					username: my_id, 
					message: "Goodbye everyone, I'm leaving!"});
		}
	}
</script>

</body>
</html>
